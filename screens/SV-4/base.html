<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Printing Service - Upload & Print (SV-4)</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #0f172a;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-2: #10b981;
      --warn: #f59e0b;
      --danger: #dc2626;
      --shadow: 0 12px 30px -18px rgba(15, 23, 42, 0.4);
      font-family: "Inter", system-ui, -apple-system, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: 72px 1fr;
      grid-template-columns: 260px 1fr;
      grid-template-areas:
        "sidebar header"
        "sidebar main";
      min-height: 100vh;
    }
    header {
      grid-area: header;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      z-index: 10;
    }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 18px; }
    .brand span { color: var(--muted); font-weight: 500; }
    .actions { display: flex; align-items: center; gap: 16px; }
    .icon-btn {
      width: 40px; height: 40px; display: grid; place-items: center;
      border-radius: 10px; border: 1px solid var(--border); background: var(--card);
      cursor: pointer; transition: 0.2s ease;
    }
    .icon-btn:hover { border-color: var(--accent); }
    .user-menu {
      display: flex; align-items: center; gap: 10px; padding: 8px 12px;
      border: 1px solid var(--border); border-radius: 12px; background: var(--card);
      cursor: pointer; transition: 0.2s ease; min-width: 170px;
    }
    .user-menu:hover { border-color: var(--accent); }
    .avatar {
      width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #2563eb, #10b981);
      color: #fff; display: grid; place-items: center; font-weight: 700;
    }
    .user-meta { display: flex; flex-direction: column; line-height: 1.2; }
    .user-meta small { color: var(--muted); }
    aside {
      grid-area: sidebar;
      background: #0f172a;
      color: #e2e8f0;
      display: flex;
      flex-direction: column;
      padding: 20px 16px;
      gap: 16px;
      position: sticky;
      top: 0;
      height: 100vh;
    }
    nav { display: flex; flex-direction: column; gap: 6px; }
    .nav-item {
      padding: 12px 14px; border-radius: 10px; color: inherit; text-decoration: none;
      display: flex; align-items: center; gap: 10px; transition: 0.2s ease;
    }
    .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.15); color: #fff; }
    .sidebar-footer {
      margin-top: auto; padding: 12px 14px; border-radius: 10px;
      background: rgba(226, 232, 240, 0.05); color: #cbd5e1; font-size: 13px; line-height: 1.5;
    }
    main { grid-area: main; padding: 28px 28px 40px; display: flex; flex-direction: column; gap: 20px; }
    .page-title { font-size: 28px; font-weight: 800; margin: 0; }
    .sub { color: var(--muted); margin-top: 6px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .section-title { margin: 0 0 8px; font-size: 18px; font-weight: 700; }
    .muted { color: var(--muted); font-size: 14px; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
    .progress {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 12px;
    }
    .step {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px;
      border: 1px solid var(--border); border-radius: 12px; background: #f8fafc;
      position: relative;
    }
    .step.active { border-color: var(--accent); box-shadow: 0 12px 24px -18px rgba(37, 99, 235, 0.5); background: #eef2ff; }
    .step.done { border-color: var(--accent-2); background: #ecfdf3; }
    .badge { width: 28px; height: 28px; border-radius: 50%; display: grid; place-items: center; background: #e5e7eb; font-weight: 700; }
    .step.active .badge { background: #2563eb; color: #fff; }
    .step.done .badge { background: #10b981; color: #fff; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #eef2ff; color: #1d4ed8; font-weight: 700; font-size: 12px; }
    .upload-drop {
      border: 2px dashed var(--border); border-radius: 14px; padding: 28px;
      display: grid; gap: 10px; place-items: center; text-align: center; background: #f9fafb;
    }
    .upload-drop input { display: none; }
    .btn {
      border: none; border-radius: 10px; cursor: pointer; transition: 0.2s ease;
      padding: 12px 14px; font-weight: 700; display: inline-flex; align-items: center; gap: 8px;
    }
    .btn.primary { background: linear-gradient(135deg, #2563eb, #3b82f6); color: #fff; box-shadow: var(--shadow); opacity: 0.9; }
    .btn.primary.enabled { opacity: 1; }
    .btn.primary.disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
    .btn.ghost { border: 1px solid var(--border); background: #f8fafc; color: #0f172a; }
    .btn.danger { background: #fee2e2; color: #b91c1c; border: 1px solid #fecdd3; }
    .file-card, .printer-card { border: 1px solid var(--border); border-radius: 12px; padding: 14px; background: var(--card); box-shadow: 0 8px 20px -18px rgba(0,0,0,0.35); }
    .file-card { display: grid; gap: 8px; }
    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .progress-bar { width: 100%; height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
    .progress-bar span { display: block; height: 100%; background: linear-gradient(135deg, #2563eb, #10b981); width: 0; transition: width 0.2s ease; }
    .info-chip { padding: 6px 10px; border-radius: 999px; background: #f1f5f9; color: #0f172a; font-size: 12px; }
    .warn-banner, .error-banner, .info-banner {
      padding: 10px 12px; border-radius: 10px; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
    }
    .warn-banner { background: #fffbeb; color: #92400e; border: 1px solid #fcd34d; }
    .error-banner { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
    .info-banner { background: #eef2ff; color: #1d4ed8; border: 1px solid #c7d2fe; }
    .printer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    .printer-card { position: relative; cursor: pointer; border: 1px solid var(--border); }
    .printer-card.selected { border-color: var(--accent); box-shadow: 0 12px 24px -18px rgba(37,99,235,0.5); }
    .printer-card.offline { opacity: 0.6; cursor: not-allowed; }
    .status { padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 700; display: inline-block; }
    .status.available { background: rgba(16,185,129,0.15); color: #047857; }
    .status.busy { background: rgba(245,158,11,0.18); color: #92400e; }
    .status.offline { background: rgba(239,68,68,0.15); color: #b91c1c; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    label { font-size: 14px; color: var(--text); display: flex; flex-direction: column; gap: 6px; }
    select, input[type="number"], input[type="text"] {
      padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px;
    }
    .radio-row { display: flex; gap: 12px; flex-wrap: wrap; }
    .radio-chip {
      border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; cursor: pointer; transition: 0.2s ease;
    }
    .radio-chip.active { border-color: var(--accent); background: #eef2ff; color: #1d4ed8; }
    .balance-card { border: 1px dashed var(--border); border-radius: 12px; padding: 14px; background: #f8fafc; display: grid; gap: 8px; }
    .balance-card.danger { border-color: #fca5a5; background: #fef2f2; color: #b91c1c; }
    .preview { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: #fff; display: grid; gap: 8px; }
    .preview-box { width: 100%; height: 180px; border-radius: 10px; background: linear-gradient(135deg, #e5e7eb, #f8fafc); display: grid; place-items: center; color: #475569; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { text-align: left; padding: 10px 8px; border-bottom: 1px solid var(--border); font-size: 14px; }
    .modal {
      position: fixed; inset: 0; background: rgba(15,23,42,0.55); display: none;
      align-items: center; justify-content: center; padding: 16px;
    }
    .modal.active { display: flex; }
    .modal-body {
      background: var(--card); border-radius: 16px; padding: 20px; width: min(620px, 100%);
      box-shadow: 0 24px 60px -30px rgba(0, 0, 0, 0.45);
    }
    .modal-header { font-weight: 800; font-size: 18px; margin: 0 0 10px; }
    .modal-row { display: flex; justify-content: space-between; padding: 6px 0; color: var(--muted); }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; }
    .success-icon { width: 64px; height: 64px; border-radius: 50%; background: rgba(16,185,129,0.12); color: #059669; display: grid; place-items: center; font-size: 32px; margin: 0 auto 12px; }
    @media (max-width: 1024px) {
      body { grid-template-columns: 90px 1fr; }
      aside { width: 90px; padding: 16px 10px; }
      .nav-item span { display: none; }
      .sidebar-footer { display: none; }
    }
    @media (max-width: 768px) {
      body { grid-template-areas: "header header" "main main"; grid-template-columns: 1fr; }
      aside { display: none; }
      .grid-2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <aside>
    <nav aria-label="Main navigation">
      <a class="nav-item" href="#"><span>Home</span></a>
      <a class="nav-item" href="#"><span>Printers Info</span></a>
      <a class="nav-item active" href="#"><span>Print Document</span></a>
      <a class="nav-item" href="#"><span>Print History</span></a>
      <a class="nav-item" href="#"><span>Buy Pages</span></a>
    </nav>
    <div class="sidebar-footer">
      <div>¬© 2025 HCMSIU</div>
      <div>Contact: support@siu.edu</div>
      <div>Version: 1.0.0</div>
    </div>
  </aside>

  <header>
    <div class="brand">
      <div class="avatar" aria-hidden="true">SIU</div>
      <div>
        Student Printing Service
        <span>‚Üí SV-4 Print Document</span>
      </div>
    </div>
    <div class="actions">
      <button class="icon-btn" aria-label="Notifications">üîî</button>
      <div class="user-menu" aria-haspopup="menu" aria-expanded="false">
        <div class="avatar" aria-hidden="true">SV</div>
        <div class="user-meta">
          <strong>Student Name</strong>
          <small>Balance: <span id="header-balance">150</span> A4</small>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div>
      <h1 class="page-title">Upload & Print</h1>
      <div class="sub">Four-step flow: Upload ‚Üí Printer ‚Üí Settings ‚Üí Confirm</div>
      <div class="row" style="margin-top:6px;">
        <span class="pill" id="step-label">Step 1 of 4</span>
        <span class="muted">Session auto-refreshes balance and printer status before submit</span>
      </div>
      <div class="progress" aria-label="Progress stepper">
        <div class="step active" data-step="1"><div class="badge">1</div><div>Upload Document</div></div>
        <div class="step" data-step="2"><div class="badge">2</div><div>Printer</div></div>
        <div class="step" data-step="3"><div class="badge">3</div><div>Settings</div></div>
        <div class="step" data-step="4"><div class="badge">4</div><div>Confirm</div></div>
      </div>
    </div>

    <!-- Step 1: Upload -->
    <section class="card" id="step-1">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h2 class="section-title">Select Document</h2>
          <div class="muted">Upload a PDF or DOCX (‚â§ 50 MB). Drag & drop supported.</div>
        </div>
        <div class="pill">PDF, DOCX only</div>
      </div>
      <div class="upload-drop" id="drop-zone">
        <div style="font-size:40px;">üìÑ</div>
        <div><strong>Drag and drop your file here or click to browse</strong></div>
        <div class="muted">PDF or DOCX (up to 50 MB)</div>
        <button class="btn ghost" id="browse-btn">Click to Browse</button>
        <input type="file" id="file-input" accept=".pdf,.doc,.docx" />
      </div>
      <div class="info-banner" id="upload-info" style="display:none;">Uploading... <span id="upload-percent">0%</span></div>
      <div class="error-banner" id="upload-error" style="display:none;">‚ùå <span id="upload-error-text">Invalid file</span> <button class="btn ghost" id="retry-upload">Retry Upload</button></div>
      <div class="file-card" id="file-card" style="display:none;">
        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <div class="avatar" style="width:48px;height:48px;">üìÑ</div>
            <div>
              <div id="file-name" style="font-weight:700;">Assignment.pdf</div>
              <div class="muted" id="file-meta">1.2 MB ‚Ä¢ 12 pages ‚Ä¢ PDF</div>
            </div>
          </div>
          <div class="row">
            <span class="info-chip" id="file-type-chip">PDF</span>
            <span class="info-chip">Stored securely; deleted after printing</span>
          </div>
        </div>
        <div class="progress-bar" aria-label="Upload progress">
          <span id="upload-bar"></span>
        </div>
        <div class="row" style="justify-content:space-between;">
          <div class="muted" id="upload-status">Uploaded</div>
          <div class="row">
            <button class="btn ghost" id="remove-file">Remove</button>
            <button class="btn primary enabled" id="to-step-2">Continue to Printer Selection</button>
          </div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px;">Allowed file types: PDF, DOCX. Max size 50 MB. Files stored securely and deleted after printing.</div>
    </section>

    <!-- Step 2: Printer Selection -->
    <section class="card" id="step-2" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h2 class="section-title">Select Printer</h2>
          <div class="muted">Filter by Campus ‚Üí Building ‚Üí Room. Offline printers are disabled.</div>
        </div>
        <div class="row">
          <button class="btn ghost" id="back-to-1">Back</button>
          <button class="btn primary disabled" id="to-step-3" aria-disabled="true">Continue to Settings</button>
        </div>
      </div>
      <div class="grid-2">
        <div class="card" style="box-shadow:none; border-style:dashed;">
          <div class="form-grid">
            <label>Campus
              <select id="filter-campus">
                <option value="">All campus</option>
              </select>
            </label>
            <label>Building
              <select id="filter-building">
                <option value="">All buildings</option>
              </select>
            </label>
            <label>Room
              <select id="filter-room">
                <option value="">All rooms</option>
              </select>
            </label>
          </div>
          <div class="muted" style="margin-top:8px;">Selections cascade. Room resets when building changes.</div>
        </div>
        <div class="warn-banner" id="printer-warn" style="display:none;">‚ö†Ô∏è No printers available at this location. Try another.</div>
      </div>
      <div class="printer-grid" id="printer-grid"></div>
    </section>

    <!-- Step 3: Settings -->
    <section class="card" id="step-3" style="display:none;">
      <div class="row" style="justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          <h2 class="section-title">Configure Print Settings</h2>
          <div class="muted">Real-time preview + page balance calculation (A4 equivalent)</div>
        </div>
        <div class="row">
          <button class="btn ghost" id="back-to-2">Back</button>
          <button class="btn primary disabled" id="to-step-4" aria-disabled="true">Continue to Confirm</button>
        </div>
      </div>
      <div class="grid-2">
        <div class="card" style="box-shadow:none;">
          <div class="form-grid">
            <label>Paper Size
              <select id="paper-size">
                <option value="A4" selected>A4</option>
                <option value="A3">A3</option>
                <option value="A5">A5</option>
              </select>
            </label>
            <label>Copies (1-99)
              <input type="number" id="copies" min="1" max="99" value="1" />
            </label>
            <label>Page Range
              <div class="radio-row" id="page-range-group">
                <div class="radio-chip active" data-range="all">All pages</div>
                <div class="radio-chip" data-range="custom">Custom</div>
              </div>
              <input type="text" id="page-range-input" placeholder="e.g., 1-5, 8, 10-12" disabled />
              <small class="muted">Enter numbers and ranges separated by commas.</small>
              <small class="error-banner" id="range-error" style="display:none;">‚ùå <span>Invalid format. Use: 1-5, 8, 10-12</span></small>
            </label>
            <label>Orientation
              <div class="radio-row" id="orientation-group">
                <div class="radio-chip active" data-value="portrait">Portrait</div>
                <div class="radio-chip" data-value="landscape">Landscape</div>
              </div>
            </label>
            <label>Sides
              <div class="radio-row" id="sides-group">
                <div class="radio-chip active" data-value="one-sided">One-sided</div>
                <div class="radio-chip" data-value="double-sided">Two-sided (Duplex)</div>
              </div>
            </label>
            <label>Color Mode
              <select id="color-mode">
                <option value="black-white" selected>Black & White</option>
                <option value="grayscale">Grayscale</option>
                <option value="color">Color</option>
              </select>
            </label>
          </div>
        </div>
        <div class="card" style="box-shadow:none;">
          <div class="preview">
            <div class="row" style="justify-content:space-between;">
              <div>
                <div class="muted">Preview</div>
                <div id="preview-desc" style="font-weight:700;">Portrait ‚Ä¢ A4</div>
              </div>
              <div class="info-chip" id="preview-side">One-sided</div>
            </div>
            <div class="preview-box" id="preview-box">Thumbnail updates with settings</div>
            <div class="balance-card" id="balance-card">
              <div style="display:flex;justify-content:space-between;">
                <strong>Page Balance Summary</strong>
                <span class="info-chip" id="balance-status-chip">Sufficient</span>
              </div>
              <div class="row" style="justify-content:space-between;">
                <div>Current Balance</div><div><strong id="balance-current">150</strong> A4</div>
              </div>
              <div class="row" style="justify-content:space-between;">
                <div>Pages to Print (A4 eq.)</div><div><strong id="balance-required">0</strong> A4</div>
              </div>
              <div class="row" style="justify-content:space-between;">
                <div>Remaining After Print</div><div><strong id="balance-remaining">150</strong> A4</div>
              </div>
              <div class="row" id="balance-warning" style="display:none; justify-content:space-between;">
                <div>Insufficient balance</div>
                <div class="row">
                  <button class="btn danger" id="buy-more">Buy More Pages</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Step 4: Confirmation -->
    <section class="card" id="step-4" style="display:none;">
      <div class="row" style="justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          <h2 class="section-title">Review & Confirm</h2>
          <div class="muted">Double-check document, printer, settings, and balance</div>
        </div>
        <div class="row">
          <button class="btn ghost" id="back-to-3">Back to Edit</button>
          <button class="btn danger" id="cancel-flow">Cancel</button>
          <button class="btn primary disabled" id="submit-job" aria-disabled="true">Submit Print Job</button>
        </div>
      </div>

      <div class="grid-2">
        <div class="card" style="box-shadow:none;">
          <h3 class="section-title" style="font-size:16px;">Document Info</h3>
          <table class="table" aria-label="Document summary">
            <tbody>
              <tr><td>File name</td><td id="sum-file">‚Äî</td></tr>
              <tr><td>File size</td><td id="sum-size">‚Äî</td></tr>
              <tr><td>Total pages</td><td id="sum-pages">‚Äî</td></tr>
            </tbody>
          </table>
          <h3 class="section-title" style="font-size:16px; margin-top:12px;">Printer Info</h3>
          <table class="table" aria-label="Printer summary">
            <tbody>
              <tr><td>Name</td><td id="sum-printer">‚Äî</td></tr>
              <tr><td>Location</td><td id="sum-location">‚Äî</td></tr>
              <tr><td>Status</td><td id="sum-status">‚Äî</td></tr>
            </tbody>
          </table>
        </div>
        <div class="card" style="box-shadow:none;">
          <h3 class="section-title" style="font-size:16px;">Print Settings</h3>
          <table class="table" aria-label="Settings summary">
            <tbody>
              <tr><td>Paper size</td><td id="sum-size-name">‚Äî</td></tr>
              <tr><td>Page range</td><td id="sum-range">‚Äî</td></tr>
              <tr><td>Orientation</td><td id="sum-orientation">‚Äî</td></tr>
              <tr><td>Sides</td><td id="sum-sides">‚Äî</td></tr>
              <tr><td>Color mode</td><td id="sum-color">‚Äî</td></tr>
              <tr><td>Copies</td><td id="sum-copies">‚Äî</td></tr>
            </tbody>
          </table>
          <h3 class="section-title" style="font-size:16px; margin-top:12px;">Page Balance</h3>
          <table class="table" aria-label="Balance summary">
            <tbody>
              <tr><td>Pages to Print</td><td id="sum-required">‚Äî</td></tr>
              <tr><td>Current balance</td><td id="sum-current">‚Äî</td></tr>
              <tr><td>Remaining after print</td><td id="sum-remaining">‚Äî</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="warn-banner" id="confirm-warning" style="display:none;">‚ö†Ô∏è Balance insufficient. Please adjust settings or buy more pages.</div>
      <div class="error-banner" id="confirm-error" style="display:none;">‚ùå Selected printer is no longer available. Please go back to choose another printer.</div>
      <div class="info-banner" id="submit-loading" style="display:none;">Submitting print job...</div>
    </section>
  </main>

  <!-- Success Modal -->
  <div class="modal" id="success-modal">
    <div class="modal-body" style="text-align:center;">
      <div class="success-icon">‚úì</div>
      <div class="modal-header">Print Job Submitted Successfully!</div>
      <div class="muted">Job ID: <strong id="success-job-id">JOB-123456</strong></div>
      <div class="modal-row"><span>Printer location</span><span id="success-location">CS1 - H1 - 101</span></div>
      <div class="modal-row"><span>Estimated completion</span><span id="success-eta">10 mins</span></div>
      <div class="modal-row"><span>Pages printed</span><span id="success-pages">12 A4</span></div>
      <div class="modal-row"><span>Balance remaining</span><span id="success-balance">138 A4</span></div>
      <div class="modal-actions" style="justify-content:center;">
        <button class="btn ghost" id="view-history">View Print History</button>
        <button class="btn primary enabled" id="print-another" style="width:auto;">Print Another Document</button>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div class="modal" id="error-modal">
    <div class="modal-body">
      <div class="modal-header">Selected printer is no longer available.</div>
      <div class="muted">Please select another printer.</div>
      <div class="modal-actions">
        <button class="btn ghost" id="error-back">Back to Printer Selection</button>
      </div>
    </div>
  </div>

  <!-- Notes for FE/dev mapping (non-rendered) -->
  <!--
    SV-4 requirements mapped:
      - Stepper shows active + completed steps; Step label updates.
      - Upload: drag-drop + click to browse; progress bar + ETA; file card; remove + retry; validation (type/size).
      - Printer selection: Cascading dropdowns; cards show status + capabilities; offline disabled; empty state banner.
      - Settings: Defaults; custom page range validation; duplex halves sheets; A3/A5 conversion; live balance check; Buy More CTA.
      - Confirmation: Re-check balance and printer availability before submit; show banners on errors.
      - Success/error modals; loading states for upload, printer status, submit.
      - Data placeholders align with design.sql entities (printer, page_size, print_job, print_job_page, student_page_purchase).
  -->

  <script>
    const state = {
      step: 1,
      balance: 150, // A4 equivalent
      file: null,
      printers: [
        { id: 'p1', name: 'HP LaserJet Pro M404dn', campus: 'CS1', building: 'H1', room: '101', status: 'available', color: true, duplex: true, queue: 0 },
        { id: 'p2', name: 'Canon iR-ADV 4525', campus: 'CS1', building: 'H1', room: '102', status: 'busy', color: true, duplex: true, queue: 3 },
        { id: 'p3', name: 'Brother HL-L2375', campus: 'CS1', building: 'H2', room: '201', status: 'offline', color: false, duplex: false, queue: 0 },
        { id: 'p4', name: 'Epson EcoTank L3250', campus: 'CS2', building: 'B1', room: '03', status: 'available', color: true, duplex: false, queue: 1 },
      ],
      selectedPrinter: null,
      settings: {
        paperSize: 'A4',
        pageRangeType: 'all',
        customRange: '',
        orientation: 'portrait',
        sides: 'one-sided',
        colorMode: 'black-white',
        copies: 1,
      },
      totalPagesInDoc: 12,
      submitBlocked: false,
    };

    // Elements
    const stepLabel = document.getElementById('step-label');
    const stepperDots = document.querySelectorAll('.step');
    const sections = {
      1: document.getElementById('step-1'),
      2: document.getElementById('step-2'),
      3: document.getElementById('step-3'),
      4: document.getElementById('step-4'),
    };

    const fileInput = document.getElementById('file-input');
    const browseBtn = document.getElementById('browse-btn');
    const dropZone = document.getElementById('drop-zone');
    const uploadInfo = document.getElementById('upload-info');
    const uploadPercent = document.getElementById('upload-percent');
    const uploadBar = document.getElementById('upload-bar');
    const uploadError = document.getElementById('upload-error');
    const uploadErrorText = document.getElementById('upload-error-text');
    const retryUpload = document.getElementById('retry-upload');
    const fileCard = document.getElementById('file-card');
    const fileNameEl = document.getElementById('file-name');
    const fileMetaEl = document.getElementById('file-meta');
    const fileTypeChip = document.getElementById('file-type-chip');
    const removeFileBtn = document.getElementById('remove-file');
    const toStep2Btn = document.getElementById('to-step-2');

    const backTo1 = document.getElementById('back-to-1');
    const toStep3Btn = document.getElementById('to-step-3');
    const printerGrid = document.getElementById('printer-grid');
    const printerWarn = document.getElementById('printer-warn');
    const filterCampus = document.getElementById('filter-campus');
    const filterBuilding = document.getElementById('filter-building');
    const filterRoom = document.getElementById('filter-room');

    const paperSize = document.getElementById('paper-size');
    const copiesInput = document.getElementById('copies');
    const rangeGroup = document.getElementById('page-range-group');
    const rangeInput = document.getElementById('page-range-input');
    const rangeError = document.getElementById('range-error');
    const orientationGroup = document.getElementById('orientation-group');
    const sidesGroup = document.getElementById('sides-group');
    const colorMode = document.getElementById('color-mode');
    const previewDesc = document.getElementById('preview-desc');
    const previewSide = document.getElementById('preview-side');
    const balanceCard = document.getElementById('balance-card');
    const balanceStatusChip = document.getElementById('balance-status-chip');
    const balanceCurrent = document.getElementById('balance-current');
    const balanceRequired = document.getElementById('balance-required');
    const balanceRemaining = document.getElementById('balance-remaining');
    const balanceWarning = document.getElementById('balance-warning');
    const buyMoreBtn = document.getElementById('buy-more');
    const toStep4Btn = document.getElementById('to-step-4');

    const backTo2 = document.getElementById('back-to-2');
    const backTo3 = document.getElementById('back-to-3');
    const cancelFlow = document.getElementById('cancel-flow');
    const submitJob = document.getElementById('submit-job');
    const confirmWarning = document.getElementById('confirm-warning');
    const confirmError = document.getElementById('confirm-error');
    const submitLoading = document.getElementById('submit-loading');

    const sumFile = document.getElementById('sum-file');
    const sumSize = document.getElementById('sum-size');
    const sumPages = document.getElementById('sum-pages');
    const sumPrinter = document.getElementById('sum-printer');
    const sumLocation = document.getElementById('sum-location');
    const sumStatus = document.getElementById('sum-status');
    const sumSizeName = document.getElementById('sum-size-name');
    const sumRange = document.getElementById('sum-range');
    const sumOrientation = document.getElementById('sum-orientation');
    const sumSides = document.getElementById('sum-sides');
    const sumColor = document.getElementById('sum-color');
    const sumCopies = document.getElementById('sum-copies');
    const sumRequired = document.getElementById('sum-required');
    const sumCurrent = document.getElementById('sum-current');
    const sumRemaining = document.getElementById('sum-remaining');

    const successModal = document.getElementById('success-modal');
    const successJobId = document.getElementById('success-job-id');
    const successLocation = document.getElementById('success-location');
    const successEta = document.getElementById('success-eta');
    const successPages = document.getElementById('success-pages');
    const successBalance = document.getElementById('success-balance');
    const viewHistory = document.getElementById('view-history');
    const printAnother = document.getElementById('print-another');
    const errorModal = document.getElementById('error-modal');
    const errorBack = document.getElementById('error-back');
    const headerBalance = document.getElementById('header-balance');

    const open = (el) => el?.classList.add('active');
    const close = (el) => el?.classList.remove('active');

    function setStep(step) {
      state.step = step;
      Object.entries(sections).forEach(([k, el]) => el.style.display = Number(k) === step ? 'block' : 'none');
      stepperDots.forEach(dot => {
        const idx = Number(dot.dataset.step);
        dot.classList.toggle('active', idx === step);
        dot.classList.toggle('done', idx < step);
      });
      stepLabel.textContent = `Step ${step} of 4`;
    }

    function resetUploadUI() {
      uploadInfo.style.display = 'none';
      uploadError.style.display = 'none';
      fileCard.style.display = 'none';
      uploadBar.style.width = '0%';
      state.file = null;
      toStep2Btn.classList.add('disabled');
      toStep2Btn.setAttribute('aria-disabled', 'true');
    }

    function mockUpload(file) {
      uploadInfo.style.display = 'flex';
      uploadPercent.textContent = '0%';
      uploadBar.style.width = '0%';
      uploadError.style.display = 'none';
      fileCard.style.display = 'none';

      let progress = 0;
      const timer = setInterval(() => {
        progress += 20;
        uploadPercent.textContent = `${progress}%`;
        uploadBar.style.width = `${progress}%`;
        if (progress >= 100) {
          clearInterval(timer);
          setTimeout(() => {
            uploadInfo.style.display = 'none';
            state.file = {
              name: file.name,
              size: file.size,
              pages: state.totalPagesInDoc,
              type: file.name.split('.').pop().toUpperCase(),
            };
            fileNameEl.textContent = state.file.name;
            fileMetaEl.textContent = `${(state.file.size / (1024 * 1024)).toFixed(2)} MB ‚Ä¢ ${state.file.pages} pages ‚Ä¢ ${state.file.type}`;
            fileTypeChip.textContent = state.file.type;
            fileCard.style.display = 'grid';
            toStep2Btn.classList.remove('disabled');
            toStep2Btn.classList.add('enabled');
            toStep2Btn.setAttribute('aria-disabled', 'false');
          }, 350);
        }
      }, 250);
    }

    function validateFile(file) {
      const allowed = ['pdf', 'doc', 'docx'];
      const ext = file.name.split('.').pop().toLowerCase();
      if (!allowed.includes(ext)) {
        uploadErrorText.textContent = 'Invalid file type. Only PDF and DOCX are allowed.';
        uploadError.style.display = 'flex';
        return false;
      }
      if (file.size > 50 * 1024 * 1024) {
        uploadErrorText.textContent = `File size exceeds 50 MB limit. Your file: ${(file.size / (1024 * 1024)).toFixed(1)} MB`;
        uploadError.style.display = 'flex';
        return false;
      }
      return true;
    }

    browseBtn?.addEventListener('click', () => fileInput.click());
    fileInput?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (!validateFile(file)) return;
      mockUpload(file);
    });
    dropZone?.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#2563eb'; });
    dropZone?.addEventListener('dragleave', () => { dropZone.style.borderColor = 'var(--border)'; });
    dropZone?.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = 'var(--border)';
      const file = e.dataTransfer.files[0];
      if (!file) return;
      if (!validateFile(file)) return;
      mockUpload(file);
    });
    retryUpload?.addEventListener('click', () => { uploadError.style.display = 'none'; fileInput.click(); });
    removeFileBtn?.addEventListener('click', resetUploadUI);

    function populateFilters() {
      const campuses = [...new Set(state.printers.map(p => p.campus))];
      filterCampus.innerHTML = '<option value="">All campus</option>' + campuses.map(c => `<option value="${c}">${c}</option>`).join('');
      filterBuilding.innerHTML = '<option value="">All buildings</option>';
      filterRoom.innerHTML = '<option value="">All rooms</option>';
    }

    function renderPrinters() {
      const campus = filterCampus.value;
      const building = filterBuilding.value;
      const room = filterRoom.value;
      const filtered = state.printers.filter(p =>
        (!campus || p.campus === campus) &&
        (!building || p.building === building) &&
        (!room || p.room === room)
      );
      printerWarn.style.display = filtered.length ? 'none' : 'flex';
      printerGrid.innerHTML = filtered.map(p => `
        <div class="printer-card ${p.status === 'offline' ? 'offline' : ''} ${state.selectedPrinter?.id === p.id ? 'selected' : ''}" data-id="${p.id}">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div style="font-weight:700;">${p.name}</div>
              <div class="muted">${p.campus} - ${p.building} - Room ${p.room}</div>
            </div>
            <span class="status ${p.status}">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}</span>
          </div>
          <div class="row" style="margin-top:8px;">
            <span class="info-chip">${p.color ? 'Color' : 'Mono'}</span>
            <span class="info-chip">${p.duplex ? 'Duplex' : 'Single-side only'}</span>
            <span class="info-chip">A4/A3</span>
          </div>
          ${p.status === 'busy' ? `<div class="muted" style="margin-top:6px;">${p.queue} jobs ahead</div>` : ''}
          ${p.status === 'offline' ? `<div class="muted" style="margin-top:6px;">Printer offline</div>` : ''}
        </div>
      `).join('');
      document.querySelectorAll('.printer-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = card.dataset.id;
          const printer = state.printers.find(p => p.id === id);
          if (printer.status === 'offline') return;
          state.selectedPrinter = printer;
          toStep3Btn.classList.remove('disabled');
          toStep3Btn.classList.add('enabled');
          toStep3Btn.setAttribute('aria-disabled', 'false');
          renderPrinters();
        });
      });
    }

    filterCampus?.addEventListener('change', () => {
      const campus = filterCampus.value;
      const buildings = [...new Set(state.printers.filter(p => !campus || p.campus === campus).map(p => p.building))];
      filterBuilding.innerHTML = '<option value="">All buildings</option>' + buildings.map(b => `<option value="${b}">${b}</option>`).join('');
      filterRoom.innerHTML = '<option value="">All rooms</option>';
      renderPrinters();
    });

    filterBuilding?.addEventListener('change', () => {
      const campus = filterCampus.value;
      const building = filterBuilding.value;
      const rooms = [...new Set(state.printers.filter(p =>
        (!campus || p.campus === campus) &&
        (!building || p.building === building)
      ).map(p => p.room))];
      filterRoom.innerHTML = '<option value="">All rooms</option>' + rooms.map(r => `<option value="${r}">${r}</option>`).join('');
      renderPrinters();
    });

    filterRoom?.addEventListener('change', renderPrinters);

    function parsePageRange(rangeStr, maxPage) {
      const clean = rangeStr.replace(/\s+/g, '');
      if (!clean) return null;
      const parts = clean.split(',');
      const pages = new Set();
      for (const part of parts) {
        if (/^\d+$/.test(part)) {
          const n = Number(part);
          if (n < 1 || n > maxPage) return { error: `Page number exceeds document length (max: ${maxPage})` };
          pages.add(n);
        } else if (/^\d+-\d+$/.test(part)) {
          const [start, end] = part.split('-').map(Number);
          if (start > end) return { error: 'Invalid range order' };
          if (end > maxPage) return { error: `Page number exceeds document length (max: ${maxPage})` };
          for (let i = start; i <= end; i++) pages.add(i);
        } else {
          return { error: 'Invalid format. Use: 1-5, 8, 10-12' };
        }
      }
      return { pages: Array.from(pages).sort((a, b) => a - b) };
    }

    function calcA4Equivalent(pageCount, paperSize, sides, copies) {
      const sizeFactor = paperSize === 'A3' ? 2 : paperSize === 'A5' ? 0.5 : 1;
      const sideFactor = sides === 'double-sided' ? 0.5 : 1;
      return Math.ceil(pageCount * sizeFactor * sideFactor * copies);
    }

    function updateBalance() {
      const pages = state.settings.pageRangeType === 'all'
        ? state.totalPagesInDoc
        : parsePageRange(state.settings.customRange, state.totalPagesInDoc)?.pages?.length || 0;

      const required = calcA4Equivalent(pages, state.settings.paperSize, state.settings.sides, state.settings.copies);
      const remaining = state.balance - required;
      const sufficient = required > 0 && remaining >= 0;

      balanceCurrent.textContent = state.balance;
      balanceRequired.textContent = required;
      balanceRemaining.textContent = Math.max(remaining, 0);
      balanceStatusChip.textContent = sufficient ? 'Sufficient' : 'Insufficient balance';
      balanceCard.classList.toggle('danger', !sufficient);
      balanceWarning.style.display = sufficient ? 'none' : 'flex';
      toStep4Btn.classList.toggle('disabled', !sufficient || !required);
      toStep4Btn.classList.toggle('enabled', sufficient && !!state.selectedPrinter && !!state.file);
      toStep4Btn.setAttribute('aria-disabled', (!sufficient || !required).toString());
      return { required, remaining, sufficient };
    }

    function updatePreview() {
      previewDesc.textContent = `${state.settings.orientation === 'portrait' ? 'Portrait' : 'Landscape'} ‚Ä¢ ${state.settings.paperSize}`;
      previewSide.textContent = state.settings.sides === 'double-sided' ? 'Two-sided' : 'One-sided';
    }

    function updateSettingsSummary() {
      const { required, remaining } = updateBalance();
      sumFile.textContent = state.file?.name || '‚Äî';
      sumSize.textContent = state.file ? `${(state.file.size / (1024 * 1024)).toFixed(2)} MB` : '‚Äî';
      sumPages.textContent = state.totalPagesInDoc;
      sumPrinter.textContent = state.selectedPrinter?.name || '‚Äî';
      sumLocation.textContent = state.selectedPrinter ? `${state.selectedPrinter.campus} - ${state.selectedPrinter.building} - Room ${state.selectedPrinter.room}` : '‚Äî';
      sumStatus.textContent = state.selectedPrinter?.status || '‚Äî';
      sumSizeName.textContent = state.settings.paperSize;
      sumRange.textContent = state.settings.pageRangeType === 'all'
        ? 'All pages'
        : state.settings.customRange || '‚Äî';
      sumOrientation.textContent = state.settings.orientation;
      sumSides.textContent = state.settings.sides === 'double-sided' ? 'Two-sided' : 'One-sided';
      sumColor.textContent = state.settings.colorMode;
      sumCopies.textContent = state.settings.copies;
      sumRequired.textContent = `${required} A4`;
      sumCurrent.textContent = `${state.balance} A4`;
      sumRemaining.textContent = `${Math.max(remaining, 0)} A4`;
      submitJob.classList.toggle('disabled', remaining < 0);
      submitJob.setAttribute('aria-disabled', (remaining < 0).toString());
      confirmWarning.style.display = remaining < 0 ? 'flex' : 'none';
    }

    function handleRadioGroup(groupEl, key) {
      groupEl.querySelectorAll('.radio-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          groupEl.querySelectorAll('.radio-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          state.settings[key] = chip.dataset.value || chip.dataset.range;
          if (key === 'pageRangeType') {
            const custom = state.settings.pageRangeType === 'custom';
            rangeInput.disabled = !custom;
            if (!custom) {
              state.settings.customRange = '';
              rangeInput.value = '';
              rangeError.style.display = 'none';
            }
          }
          updatePreview();
          updateSettingsSummary();
        });
      });
    }

    handleRadioGroup(rangeGroup, 'pageRangeType');
    handleRadioGroup(orientationGroup, 'orientation');
    handleRadioGroup(sidesGroup, 'sides');

    rangeInput?.addEventListener('input', (e) => {
      state.settings.customRange = e.target.value;
      const parsed = parsePageRange(state.settings.customRange, state.totalPagesInDoc);
      if (parsed?.error) {
        rangeError.style.display = 'flex';
        rangeError.querySelector('span').textContent = parsed.error;
      } else {
        rangeError.style.display = 'none';
      }
      updateSettingsSummary();
    });

    paperSize?.addEventListener('change', (e) => {
      state.settings.paperSize = e.target.value;
      updatePreview();
      updateSettingsSummary();
    });
    copiesInput?.addEventListener('input', (e) => {
      const val = Math.max(1, Math.min(99, Number(e.target.value) || 1));
      e.target.value = val;
      state.settings.copies = val;
      updateSettingsSummary();
    });
    colorMode?.addEventListener('change', (e) => { state.settings.colorMode = e.target.value; updateSettingsSummary(); });

    toStep2Btn?.addEventListener('click', () => {
      if (toStep2Btn.classList.contains('disabled')) return;
      setStep(2);
    });
    backTo1?.addEventListener('click', () => setStep(1));
    toStep3Btn?.addEventListener('click', () => {
      if (toStep3Btn.classList.contains('disabled')) return;
      setStep(3);
      updateSettingsSummary();
    });
    backTo2?.addEventListener('click', () => setStep(2));
    toStep4Btn?.addEventListener('click', () => {
      if (toStep4Btn.classList.contains('disabled')) return;
      setStep(4);
      updateSettingsSummary();
    });
    backTo3?.addEventListener('click', () => setStep(3));
    cancelFlow?.addEventListener('click', () => {
      if (!confirm('Are you sure you want to cancel?')) return;
      resetUploadUI();
      state.selectedPrinter = null;
      setStep(1);
    });

    submitJob?.addEventListener('click', () => {
      if (submitJob.classList.contains('disabled')) return;
      submitLoading.style.display = 'flex';
      confirmError.style.display = 'none';
      setTimeout(() => {
        submitLoading.style.display = 'none';
        // Double-check balance and printer status
        const printerStillOnline = state.selectedPrinter?.status !== 'offline';
        if (!printerStillOnline) {
          confirmError.style.display = 'flex';
          open(errorModal);
          return;
        }
        // Success path
        successJobId.textContent = `JOB-${Math.floor(Math.random() * 900000 + 100000)}`;
        successLocation.textContent = sumLocation.textContent;
        successEta.textContent = '10 mins';
        successPages.textContent = sumRequired.textContent;
        successBalance.textContent = sumRemaining.textContent;
        headerBalance.textContent = Math.max(state.balance - Number(balanceRequired.textContent), 0);
        open(successModal);
      }, 900);
    });

    errorBack?.addEventListener('click', () => { close(errorModal); setStep(2); });
    viewHistory?.addEventListener('click', () => alert('Navigate to print history'));
    printAnother?.addEventListener('click', () => { close(successModal); resetUploadUI(); setStep(1); });

    buyMoreBtn?.addEventListener('click', () => window.open('#buy-pages', '_blank'));

    // Init
    setStep(1);
    populateFilters();
    renderPrinters();
    updatePreview();
    updateSettingsSummary();
  </script>
</body>
</html>

