# MÔ TẢ CÁC BIỂU ĐỒ UML - MODULE QUẢN LÝ IN ẤN

## 2.1. ACTIVITY DIAGRAMS (Biểu Đồ Hoạt Động)

### 2.1.1. Biểu Đồ Hoạt Động - In Tài Liệu (Print Document Activity Diagram)

Quy trình in tài liệu bắt đầu khi sinh viên tải lên file tài liệu cần in và hệ thống lưu trữ file, đếm số trang. Sinh viên chọn máy in, sau đó cấu hình các tùy chọn in bao gồm kích thước giấy (A3, A4, A5), chế độ màu (đen trắng, xám, màu), số bản sao, và kiểu in (một mặt hoặc hai mặt). Hệ thống tính toán chi phí dựa trên số trang, kích thước giấy, hệ số màu, hệ số in hai mặt, và gói giảm giá (nếu đủ điều kiện), sau đó hiển thị bản xem trước chi phí cho sinh viên. Sinh viên chọn phương thức thanh toán: nếu thanh toán bằng số dư tài khoản, hệ thống kiểm tra số dư có đủ hay không; nếu đủ, hệ thống trừ tiền từ số dư và tạo công việc in; nếu không đủ, hệ thống yêu cầu thanh toán bổ sung hoặc từ chối. Nếu sinh viên chọn thanh toán trực tiếp (ví điện tử, thẻ), hệ thống tạo liên kết thanh toán và chờ xác nhận từ cổng thanh toán. Sau khi thanh toán thành công, hệ thống tạo công việc in trong cơ sở dữ liệu, gửi lệnh in đến máy in vật lý được chọn, và máy in bắt đầu in tài liệu. Hệ thống theo dõi tiến trình in, cập nhật trạng thái từng trang đã in, và khi hoàn thành, cập nhật trạng thái công việc in, ghi nhận giao dịch thanh toán vào sổ cái tài chính, và gửi thông báo xác nhận in thành công cho sinh viên.

### 2.1.2. Biểu Đồ Hoạt Động - Hủy Công Việc In (Cancel Print Job Activity Diagram)

Quy trình hủy công việc in bắt đầu khi sinh viên gửi yêu cầu hủy một công việc in. Hệ thống kiểm tra trạng thái hiện tại của công việc in: nếu công việc đã hoàn thành, hệ thống từ chối yêu cầu hủy và thông báo cho sinh viên; nếu công việc đang chờ xử lý, hệ thống hủy ngay lập tức và tính toán số tiền hoàn lại; nếu công việc đang được in, hệ thống gửi lệnh dừng đến máy in vật lý. Máy in dừng quá trình in hiện tại và báo cáo lại số trang đã in thành công. Hệ thống tính toán số trang chưa in bằng cách lấy tổng số trang trừ đi số trang đã in, sau đó tính toán số tiền hoàn lại dựa trên giá đã thanh toán và số trang chưa in. Hệ thống tạo bản ghi hoàn tiền trong cơ sở dữ liệu, cập nhật số dư tài khoản của sinh viên bằng cách cộng lại số tiền hoàn lại, và ghi nhận giao dịch hoàn tiền vào sổ cái tài chính. Cuối cùng, hệ thống cập nhật trạng thái công việc in thành "đã hủy", cập nhật trạng thái các trang chưa in, và gửi thông báo xác nhận hủy cùng với thông tin hoàn tiền cho sinh viên.

### 2.1.3. Biểu Đồ Hoạt Động - Nạp Tiền Vào Tài Khoản (Deposit to Account Activity Diagram)

Quy trình nạp tiền vào tài khoản bắt đầu khi sinh viên chọn số tiền muốn nạp và phương thức thanh toán (chuyển khoản ngân hàng, ví điện tử, hoặc thẻ). Hệ thống kiểm tra các gói khuyến mãi hiện có và tính toán số tiền thưởng dựa trên số tiền nạp và tỷ lệ thưởng của gói khuyến mãi phù hợp. Hệ thống tạo mã giao dịch nạp tiền, sau đó tạo mã QR hoặc liên kết thanh toán thông qua cổng thanh toán bên thứ ba (như SePay). Sinh viên quét mã QR hoặc truy cập liên kết thanh toán và thực hiện thanh toán trên ứng dụng ngân hàng hoặc ví điện tử của mình. Cổng thanh toán xử lý giao dịch và gửi webhook xác nhận về hệ thống khi thanh toán thành công. Hệ thống nhận webhook, xác thực tính hợp lệ của giao dịch bằng cách kiểm tra mã giao dịch, số tiền, và chữ ký xác thực. Nếu webhook hợp lệ, hệ thống cập nhật trạng thái giao dịch nạp tiền từ "đang chờ" thành "hoàn thành", tính tổng số tiền được cộng vào tài khoản (số tiền nạp cộng với tiền thưởng), cập nhật số dư tài khoản của sinh viên, và ghi nhận hai bản ghi vào sổ cái tài chính: một cho số tiền nạp và một cho tiền thưởng (nếu có). Cuối cùng, hệ thống gửi thông báo xác nhận nạp tiền thành công cho sinh viên, bao gồm số tiền đã nạp, tiền thưởng (nếu có), và số dư tài khoản mới.

## 2.2. SEQUENCE DIAGRAMS (Biểu Đồ Tuần Tự)

### 2.2.1. Biểu Đồ Tuần Tự - In Tài Liệu (Print Document Sequence Diagram)

Khi sinh viên tải lên file tài liệu qua giao diện web, giao diện gửi file đến Backend API để lưu trữ và API trả về xác nhận file đã được tải lên. Sinh viên chọn máy in từ danh sách, giao diện gọi API để lấy danh sách máy in có sẵn và hiển thị cho sinh viên. Sinh viên cấu hình các tùy chọn in (kích thước giấy, chế độ màu, số bản sao, kiểu in), giao diện gửi yêu cầu tính toán chi phí đến API. API gọi PricingService để tính toán giá dựa trên các thông số, PricingService truy vấn cơ sở dữ liệu để lấy giá cơ bản theo kích thước giấy, hệ số màu, và kiểm tra gói giảm giá phù hợp, sau đó trả về tổng chi phí. API hiển thị bản xem trước chi phí cho sinh viên. Nếu sinh viên chọn thanh toán bằng số dư, giao diện gửi yêu cầu tạo công việc in đến API. API gọi PaymentService để xử lý thanh toán: PaymentService kiểm tra số dư tài khoản của sinh viên, nếu đủ tiền thì trừ số tiền từ số dư và trả về xác nhận thanh toán thành công; nếu không đủ, trả về lỗi. Nếu thanh toán thành công, API tạo bản ghi công việc in trong cơ sở dữ liệu, gửi lệnh in đến PrinterController, và PrinterController điều khiển máy in vật lý để bắt đầu in. Máy in báo cáo tiến trình in về PrinterController, PrinterController cập nhật trạng thái từng trang đã in về API, và API cập nhật vào cơ sở dữ liệu. Khi in hoàn thành, API cập nhật trạng thái công việc in, ghi nhận giao dịch thanh toán vào sổ cái, và gửi thông báo xác nhận đến giao diện để hiển thị cho sinh viên.

### 2.2.2. Biểu Đồ Tuần Tự - Hủy Công Việc In (Cancel Print Job Sequence Diagram)

Khi sinh viên yêu cầu hủy một công việc in qua giao diện web, giao diện gửi yêu cầu hủy đến Backend API. API nhận yêu cầu và truy vấn cơ sở dữ liệu để lấy thông tin công việc in, bao gồm trạng thái hiện tại (đang chờ, đang in, hoặc đã hoàn thành). Nếu công việc đã hoàn thành, API trả về lỗi từ chối hủy cho giao diện và giao diện hiển thị thông báo cho sinh viên. Nếu công việc đang chờ xử lý, API hủy ngay lập tức và gọi RefundService để tính toán hoàn tiền. Nếu công việc đang được in, API gửi lệnh dừng đến PrinterController, PrinterController điều khiển máy in vật lý để dừng quá trình in, máy in báo cáo lại số trang đã in thành công, và PrinterController trả về thông tin này cho API. API gọi RefundService để tính toán số tiền hoàn lại: RefundService truy vấn thông tin thanh toán từ cơ sở dữ liệu để lấy tổng số tiền đã thanh toán, tính số trang chưa in (tổng số trang trừ số trang đã in), tính số tiền hoàn lại dựa trên giá mỗi trang và số trang chưa in, sau đó trả về số tiền hoàn lại cho API. API cập nhật số dư tài khoản của sinh viên bằng cách cộng lại số tiền hoàn lại, tạo bản ghi hoàn tiền trong cơ sở dữ liệu, ghi nhận giao dịch hoàn tiền vào sổ cái tài chính, và cập nhật trạng thái công việc in thành "đã hủy". Cuối cùng, API trả về xác nhận hủy thành công cùng thông tin hoàn tiền cho giao diện và giao diện hiển thị thông báo cho sinh viên.

### 2.2.3. Biểu Đồ Tuần Tự - Nạp Tiền Vào Tài Khoản (Deposit to Account Sequence Diagram)

Khi sinh viên chọn số tiền nạp và phương thức thanh toán qua giao diện web, giao diện gửi yêu cầu nạp tiền đến Backend API. API nhận yêu cầu và gọi BonusService để kiểm tra các gói khuyến mãi hiện có: BonusService truy vấn cơ sở dữ liệu để tìm gói khuyến mãi phù hợp dựa trên số tiền nạp, tính toán số tiền thưởng dựa trên tỷ lệ thưởng của gói, và trả về số tiền thưởng cho API. API tạo mã giao dịch nạp tiền duy nhất và gọi PaymentGateway để tạo mã QR hoặc liên kết thanh toán. PaymentGateway tạo mã QR với thông tin giao dịch, thiết lập thời gian hết hạn (thường là 10 phút), và trả về mã QR cùng thời gian hết hạn cho API. API lưu thông tin giao dịch nạp tiền vào cơ sở dữ liệu với trạng thái "đang chờ" và trả về mã QR cho giao diện. Giao diện hiển thị mã QR cho sinh viên, sinh viên quét mã QR và thực hiện thanh toán trên ứng dụng ngân hàng hoặc ví điện tử. PaymentGateway xử lý thanh toán và gửi webhook xác nhận về API khi giao dịch thành công. API nhận webhook, xác thực tính hợp lệ bằng cách kiểm tra mã giao dịch, số tiền, và chữ ký xác thực. Nếu webhook hợp lệ, API cập nhật trạng thái giao dịch nạp tiền thành "hoàn thành", tính tổng số tiền được cộng (số tiền nạp cộng tiền thưởng), và gọi LedgerService để ghi nhận vào sổ cái: LedgerService tạo bản ghi cho số tiền nạp với hướng "IN" và nguồn "DEPOSIT", nếu có tiền thưởng thì tạo thêm bản ghi cho tiền thưởng với nguồn "SEMESTER_BONUS", và trả về xác nhận cho API. API cập nhật số dư tài khoản của sinh viên, trả về xác nhận nạp tiền thành công cho giao diện, và giao diện hiển thị thông báo thành công cùng số dư mới cho sinh viên.

## 2.3. CLASS DIAGRAMS (Biểu Đồ Lớp)

### 2.3.1. Biểu Đồ Lớp - In Tài Liệu (Print Document Class Diagram)

Cấu trúc dữ liệu cho use case in tài liệu được tổ chức theo các mức phụ thuộc, với các lớp độc lập ở trên cùng và các lớp phụ thuộc ở dưới. Lớp Student đại diện cho thông tin sinh viên và có thể tạo nhiều công việc in. Lớp UploadedFile lưu trữ thông tin file tài liệu mà sinh viên đã tải lên, mỗi file thuộc về một sinh viên. Các lớp PageSizePrice, ColorModePrice, và PageDiscountPackage lưu trữ thông tin định giá: PageSizePrice chứa giá cơ bản cho mỗi kích thước giấy, ColorModePrice chứa hệ số nhân giá cho từng chế độ màu, và PageDiscountPackage chứa thông tin về các gói giảm giá dựa trên số trang. Lớp PrinterPhysical đại diện cho máy in vật lý trong hệ thống. Lớp PrintJob là trung tâm của use case, lưu trữ thông tin về một công việc in cụ thể, bao gồm các tùy chọn in, số trang, và tổng chi phí. PrintJob tham chiếu đến PageSizePrice, ColorModePrice, và PageDiscountPackage để tính toán giá, sử dụng UploadedFile để biết file nào cần in, và được gán cho một PrinterPhysical để in. PrintJob sở hữu nhiều PrintJobPage, mỗi PrintJobPage đại diện cho một trang cụ thể trong công việc in và theo dõi trạng thái in của trang đó. Mỗi PrintJob có một Payment để ghi nhận thông tin thanh toán, và có thể có một RefundPrintJob nếu công việc bị hủy và cần hoàn tiền.

### 2.3.2. Biểu Đồ Lớp - Hủy Công Việc In (Cancel Print Job Class Diagram)

Cấu trúc dữ liệu cho use case hủy công việc in tập trung vào các lớp liên quan trực tiếp đến quy trình hủy và hoàn tiền. Lớp Student đại diện cho sinh viên sở hữu công việc in. Lớp PrinterPhysical đại diện cho máy in đang thực hiện công việc in. Lớp PrintJob là trung tâm, lưu trữ thông tin về công việc in bao gồm trạng thái (đang chờ, đang in, đã hoàn thành, đã hủy), thời gian bắt đầu và kết thúc. PrintJob sở hữu nhiều PrintJobPage, mỗi PrintJobPage đại diện cho một trang trong công việc in và có thuộc tính is_printed để xác định trang đã được in hay chưa, cùng với thời gian in nếu đã in. Lớp Payment lưu trữ thông tin về thanh toán ban đầu của công việc in, bao gồm số tiền đã thanh toán từ số dư và số tiền thanh toán trực tiếp. Lớp RefundPrintJob được tạo khi công việc in bị hủy, lưu trữ số trang chưa in để tính toán số tiền hoàn lại. Mối quan hệ giữa các lớp cho thấy: một sinh viên có thể có nhiều công việc in, một máy in có thể thực hiện nhiều công việc in, mỗi công việc in có một thanh toán, và mỗi công việc in có thể có một hoàn tiền nếu bị hủy.

### 2.3.3. Biểu Đồ Lớp - Nạp Tiền Vào Tài Khoản (Deposit to Account Class Diagram)

Cấu trúc dữ liệu cho use case nạp tiền vào tài khoản được thiết kế để quản lý các giao dịch nạp tiền và ghi nhận vào sổ cái tài chính. Lớp Student đại diện cho sinh viên thực hiện nạp tiền. Lớp DepositBonusPackage lưu trữ thông tin về các gói khuyến mãi nạp tiền, bao gồm số tiền tối thiểu để được hưởng khuyến mãi và tỷ lệ thưởng. Lớp Deposit là trung tâm của use case, lưu trữ thông tin về một giao dịch nạp tiền cụ thể, bao gồm số tiền nạp, số tiền thưởng (nếu có), tổng số tiền được cộng vào tài khoản, phương thức thanh toán, mã giao dịch, và trạng thái thanh toán. Deposit có thể tham chiếu đến một DepositBonusPackage nếu giao dịch đủ điều kiện nhận khuyến mãi. Mỗi Deposit tạo ra một hoặc nhiều bản ghi trong StudentWalletLedger, đây là sổ cái tài chính trung tâm ghi nhận tất cả các giao dịch tài chính trong hệ thống. StudentWalletLedger lưu trữ số tiền (dương cho giao dịch vào, âm cho giao dịch ra), hướng giao dịch (IN hoặc OUT), loại nguồn giao dịch (DEPOSIT, SEMESTER_BONUS, PAYMENT, REFUND), và tham chiếu đến bản ghi nguồn trong bảng tương ứng. Mối quan hệ giữa các lớp cho thấy: một sinh viên có thể thực hiện nhiều giao dịch nạp tiền, một gói khuyến mãi có thể áp dụng cho nhiều giao dịch nạp tiền, và mỗi giao dịch nạp tiền tạo ra ít nhất một bản ghi sổ cái (một cho số tiền nạp và có thể thêm một cho tiền thưởng).

## 2.4. COMPONENT DIAGRAMS (Biểu Đồ Thành Phần)

### 2.4.1. Biểu Đồ Thành Phần - Module Quản Lý In Ấn (Print Management Component Diagram)

Kiến trúc hệ thống module quản lý in ấn được tổ chức thành bốn tầng chính: Frontend Layer, API Gateway Layer, Business Logic Layer, và Infrastructure Layer. Tầng Frontend chứa Web UI, nơi sinh viên tương tác với hệ thống thông qua giao diện web để tải file, chọn máy in, cấu hình tùy chọn in, và thực hiện thanh toán. Web UI gửi các yêu cầu HTTP đến Backend API ở tầng API Gateway, Backend API đóng vai trò là điểm vào duy nhất, định tuyến các yêu cầu đến các service phù hợp trong tầng Business Logic. Tầng Business Logic bao gồm Print Service (quản lý công việc in), Pricing Service (tính toán giá), Payment Service (xử lý thanh toán), Refund Service (xử lý hoàn tiền), Deposit Service (xử lý nạp tiền), Bonus Service (tính toán tiền thưởng), và Ledger Service (quản lý sổ cái tài chính). Print Service phụ thuộc vào Pricing Service để tính giá, Payment Service để xử lý thanh toán, và Printer Controller để điều khiển máy in. Payment Service và Refund Service đều sử dụng Ledger Service để ghi nhận các giao dịch tài chính vào sổ cái. Deposit Service sử dụng Bonus Service để tính tiền thưởng, Payment Gateway để xử lý thanh toán bên ngoài, và Ledger Service để ghi nhận giao dịch. Tầng Infrastructure bao gồm Printer Controller (điều khiển máy in vật lý), Payment Gateway (kết nối với cổng thanh toán bên thứ ba), và Database (lưu trữ tất cả dữ liệu). Tất cả các service trong tầng Business Logic đều truy cập Database để đọc và ghi dữ liệu. Kiến trúc này cho phép tách biệt các mối quan tâm, dễ dàng bảo trì và mở rộng từng thành phần độc lập.
